<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
  </head>
  <body>
    <script>
      redditInfo = {
        getURL: function(url) {
          return this.url[url];
        },
        
        setURL: function(url, info) {
          this.url[url] = info;
          this.fullname[info.fullname] = info;
        },

        lookupURL: function(url, callback) {
          var info = this.getURL(url);
          if (info) {
            callback(info);
          } else {
            console.log('Performing AJAX info call for '+url);
            $.ajax({
              url: 'http://www.reddit.com/api/info.json',
              data: {limit:1, url:url},
              success: function(resp) {
                if (resp.data) {
                  var info = resp.data.children[0].data;
                  redditInfo.setURL(url, info);
                  callback(info);
                }
              },
              error: function() {
                callback(null);
              }
            });
          }
        },
        
        url: {}, 
        fullname: {}
      };
      tabInfo = {};

      function addContent(tabId, pieces, callback) {
        var piece = pieces.shift();
        if (piece) {
          console.log('Injecting', piece);
          if (piece.type == 'js') {
            var inject = chrome.tabs.executeScript;
          } else if (piece.type == 'css') {
            var inject = chrome.tabs.insertCSS;
          }
          delete piece.type;
          
          inject(tabId, piece, function() {
            addContent(tabId, pieces, callback);
          });
        } else {
          if (callback) {
            callback();
          }
        }
      }

      function addOverlayContent(tab, callback) {
        addContent(tab.id, [{type:'js',  file:'jquery-1.4.2.min.js'},
                            {type:'css', file:'pageOverlay.css'},
                            {type:'js',  file:'pageOverlay.js'}], callback);
      }

      function showOverlay(tab, info) {
        console.log("Sending show overlay command for", info);
        chrome.tabs.sendRequest(tab.id, {action:'showOverlay', info:info});
      }

      function ensureOverlay(tab, info) {
        console.log('Ensuring overlay for '+tab.id, info);
        if (!tabInfo[tab.id]) {
          addOverlayContent(tab, function() { 
            tabInfo[tab.id] = true;
            showOverlay(tab, info);
          });
        } else {
          showOverlay(tab, info);
        }
      }

      function onTabLoad(tab) {
        if (/^http:\/\/.*/.test(tab.url)) {
          chrome.pageAction.show(tab.id);
          var info = redditInfo.url[tab.url];
          if (info) {
            console.log('Recognized page '+tab.url+' ('+info.fullname+')');
            ensureOverlay(tab, info);
          }
        }
      }

      function onActionClicked(tab) {
        redditInfo.lookupURL(tab.url, function(info) {
          ensureOverlay(tab, info);
        })
      }

      function onRequest(request, sender, callback) {
        if (request.action == 'thingClick') {
          console.log('Thing clicked', request);
          redditInfo.setURL(request.url, request.info);
        } else if (request.action == 'query') {
          if (request.hasOwnProperty('url')) {
            callback(redditInfo.url[request.url]);
          } else if (request.hasOwnProperty('fullname')) {
            callback(redditInfo.fullname[request.fullname]);
          }
        }
      }

      chrome.extension.onRequest.addListener(onRequest);
      chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
        if (changeInfo.status == 'loading') {
          tabInfo[tabId] = false;
          onTabLoad(tab);
        }
      });
      chrome.pageAction.onClicked.addListener(onActionClicked);
    </script>
  </body>
</html>
