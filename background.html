<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
    <script>
      redditInfo = {
        getURL: function(url) {
          return this.url[url];
        },
        
        setURL: function(url, info) {
          this.url[url] = info;
          this.fullname[info.fullname] = info;
        },

        lookupURL: function(url, callback) {
          this._queryInfo({url:url}, callback);
        },

        lookupName: function(name, callback) {
          this._queryInfo({id:name}, callback);
        },

        _queryInfo: function(params, callback) {
          console.log('Performing AJAX info call for ', params);
          params.limit = 1;
          $.ajax({
            url: 'http://www.reddit.com/api/info.json',
            data: params,
            success: function(resp) {
              if (resp.data) {
                var info = resp.data.children[0].data;
                redditInfo.modhash = resp.data.modhash;
                redditInfo.setURL(info.url, info);
                tabStatus.updateOverlay(info);
                if (callback) { callback(info); }
              }
            },
            error: function() {
              if (callback) { callback(null); }
            }
          });
        },

        vote: function(fullname, likes, callback) {
          if (!this.modhash) {
            this.lookupName(fullname, function() {
              // Retry after we've stashed a modhash.
              redditInfo.vote(fullname, likes, callback);
            });
            return
          }
        
          var dir;
          if (likes == true) {
            dir = 1;
          } else if (likes == false) {
            dir = -1;
          } else {
            dir = 0;
          }
          
          $.ajax({
            type: 'POST',
            url: 'http://www.reddit.com/api/vote',
            data: {id:fullname, dir:dir, uh:this.modhash},
            success: function(resp) { callback(true); },
            error: function() { callback(false); }
          });
        },

        modhash: null,
        url: {}, 
        fullname: {}
      };

      tabStatus = {
        add: function(tabId, fullname) {
          this.tabId[tabId] = fullname;
          
          if (!this.fullname[fullname]) {
            this.fullname[fullname] = [];
          }
          this.fullname[fullname].push(tabId); 
        },
        
        remove: function(tabId) {
          var fullname = this.tabId[tabId];
          if (fullname) {
            delete this.tabId[tabId];
            this.fullname[fullname].filter(function(x) {return x != tabID});
            if (!this.fullname[fullname]) {
              delete this.fullname[fullname];
            }
          }
        },

        updateOverlay: function(info) {
          if (this.fullname[info.name]) {
            this.fullname[info.name].forEach(function(tabId) {
              console.log("Sending show overlay command for", info);
              chrome.tabs.sendRequest(tabId, {action:'showInfo', info:info});
            });
          }
        },
        
        tabId: {},
        fullname: {}
      };

      function addContent(tab, pieces, callback) {
        var piece = pieces.shift();
        if (piece) {
          console.log('Injecting', piece);
          if (piece.type == 'js') {
            var inject = chrome.tabs.executeScript;
          } else if (piece.type == 'css') {
            var inject = chrome.tabs.insertCSS;
          }
          delete piece.type;
          
          inject(tab.id, piece, function() {
            addContent(tab, pieces, callback);
          });
        } else {
          if (callback) { callback(); }
        }
      }

      function addOverlayContent(tab, callback) {
        addContent(tab, [{type:'js',  file:'jquery-1.4.2.min.js'},
                         {type:'css', file:'pageOverlay.css'},
                         {type:'js',  file:'pageOverlay.js'}], callback);
      }

      function ensureOverlay(tab, info) {
        console.log('Ensuring overlay for '+tab.id, info);
        if (!tabStatus.tabId[tab.id]) {
          addOverlayContent(tab, function() { 
            tabStatus.add(tab.id, info.name);
            tabStatus.updateOverlay(info);
          });
        } else {
          tabStatus.updateOverlay(info);
        }
      }

      function onTabLoad(tab) {
        if (/^http:\/\/.*/.test(tab.url)) {
          chrome.pageAction.show(tab.id);
          var info = redditInfo.url[tab.url];
          if (info) {
            console.log('Recognized page '+tab.url, info);
            ensureOverlay(tab, info);
          }
        }
      }

      function onActionClicked(tab) {
        var frame = 0;
        var workingAnimation = window.setInterval(function() {
          chrome.pageAction.setIcon({tabId:tab.id, path:'/images/working'+frame+'.png'});
          frame = (frame + 1) % 6;
        }, 200);
        redditInfo.lookupURL(tab.url, function(info) {
          window.clearInterval(workingAnimation);
          chrome.pageAction.setIcon({tabId:tab.id, path:'/images/reddit.png'});
          ensureOverlay(tab, info);
        })
      }

      function onRequest(request, sender, callback) {
        if (request.action == 'thingClick') {
          console.log('Thing clicked', request);
          redditInfo.setURL(request.url, request.info);
          redditInfo.lookupName(request.info.name);
        } else if (request.action == 'query') {
          if (request.hasOwnProperty('url')) {
            callback(redditInfo.url[request.url]);
          } else if (request.hasOwnProperty('fullname')) {
            callback(redditInfo.fullname[request.fullname]);
          }
        } else if (request.action == 'vote') {
          console.log('Voting', request);
          redditInfo.vote(request.fullname, request.likes, callback);
        }
      }

      chrome.extension.onRequest.addListener(onRequest);
      chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
        if (changeInfo.status == 'loading') {
          tabStatus.remove(tabId);
          onTabLoad(tab);
        }
      });
      chrome.pageAction.onClicked.addListener(onActionClicked);
    </script>
  </head>
  <body>
  </body>
</html>
