<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script>
      redditInfo = {};

      function addContent(tabId, pieces) {
        var piece = pieces.shift();
        if (piece) {
          console.log('Injecting', piece);
          if (piece.type == 'js') {
            var inject = chrome.tabs.executeScript;
          } else if (piece.type == 'css') {
            var inject = chrome.tabs.insertCSS;
          }
          delete piece.type;
          
          inject(tabId, piece, function() {
            addContent(tabId, pieces);
          });
        }
      }

      function onTabLoad(tab) { 
        if (redditInfo.hasOwnProperty(tab.url)) {
          var info = redditInfo[tab.url];
          console.log('Recognized page '+tab.url+' ('+info.fullname+')');
          addContent(tab.id, [{type:'js',  file:'jquery-1.4.2.min.js'},
                              {type:'css', file:'pageOverlay.css'},
                              {type:'js',  file:'pageOverlay.js'}]);
        }
      }

      function onRequest(request, sender, callback) {
        if (request.action == 'thingClick') {
          console.log('Thing clicked', request);
          redditInfo[request.url] = request.info;
        } else if (request.action == 'queryURL') {
          callback(redditInfo[request.url]);
        }
      }

      chrome.extension.onRequest.addListener(onRequest);
      chrome.tabs.onCreated.addListener(function(tab) {
        onTabLoad(tab);
      });
      chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
        if (changeInfo.status == 'loading') {
          onTabLoad(tab);
        }
      });
    </script>
  </body>
</html>
