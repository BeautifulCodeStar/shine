<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="bar.css" type="text/css" />
    <script type="text/javascript" src="jquery-1.4.2.min.js"></script>
    <script type="text/javascript">
      function msgJSON(request) {
        window.top.postMessage(JSON.stringify(request), "*");
      }

      function likeDelta(likes) {
        if (likes == true) {
          return 1;
        } else if (likes == false) {
          return -1;
        } else {
          return 0;
        }
      }

      function vote(likes) {
        info.score += likeDelta(likes) - likeDelta(info.likes);
        info.likes = likes;
        update();
        msgJSON({action:'vote', fullname:info.fullname, likes:info.likes});
      }
    
      function update() {      
        if (info.likes == true) {
          $('#bar').attr('class', 'liked');
        } else if (info.likes == false) {
          $('#bar').attr('class', 'disliked');
        } else {
          $('#bar').attr('class', '');
        }
        $('#score').text(info.score);
        $('#title').text(info.title)
        $('#comments').text(info.num_comments);

        window.setTimeout(function() {
          msgJSON({action:'size', width:$('#bar').outerWidth(), height:$('#bar').outerHeight()});
        }, 0)
      }

      function handleData() {
        info = JSON.parse(decodeURIComponent(location.hash.substr(1)));
        update();
      }

      $(document).ready(function() {
        $(window).resize(function () {
          console.log('Resize alert detected; updating shine display.');
          handleData();
        });
      
        $('#comments').click(function() {
          window.top.location = 'http://reddit.com'+info.permalink;
        })
        
        $('#like').click(function() {
          vote(info.likes == true ? null : true);
        });

        $('#dislike').click(function() {
          vote(info.likes == false ? null : false);
        });

        $('#close').click(function() {
          msgJSON({action:'close'});
        });

        handleData();
      });
    </script>
  </head>
  <body>
    <div id="bar">
        <a id="logo" href="http://www.reddit.com" target="_top"></a>
        <span id="score">?</span> <span id="title"></span>
        <div id="buttons">
          <button id="like">Like</button>
          <button id="dislike">Dislike</button>
          <button id="comments">?</button>
          <button id="close" ><img src="/images/close.png" alt="close"/></button>
        </div>
    </div>
  </body>
</html>
